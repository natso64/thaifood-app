@echo off
chcp 65001 >nul
cls

echo ================================================================
echo ЁЯН▓ Thai Food Nutrition Analyzer - р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
echo ================================================================
echo.

:: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣М admin (р╕Цр╣Йр╕▓р╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ)
net session >nul 2>&1
if %errorlevel% == 0 (
    echo тЬЕ р╕Хр╕гр╕зр╕Ир╕Юр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣М Administrator
) else (
    echo тЪая╕П  р╕Бр╕│р╕ер╕▒р╕Зр╕гр╕▒р╕Щр╕Фр╣Йр╕зр╕вр╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Ыр╕Бр╕Хр╕┤
)

echo ЁЯФН р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕зр╕▓р╕бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ъ...
echo.

:: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Python
python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo тЭМ р╣Др╕бр╣Ир╕Юр╕Ъ Python! р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Python 3.8+ р╕Ир╕▓р╕Б https://www.python.org/
    echo.
    echo ЁЯУЛ р╕зр╕┤р╕Шр╕╡р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Python:
    echo    1. р╣Др╕Ыр╕Чр╕╡р╣И https://www.python.org/downloads/
    echo    2. р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Ф Python 3.8 р╕лр╕гр╕╖р╕нр╣Гр╕лр╕бр╣Ир╕Бр╕зр╣Ир╕▓
    echo    3. р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Вр╕Фр╕вр╣Ар╕ер╕╖р╕нр╕Б "Add Python to PATH"
    echo    4. р╕гр╕╡р╕кр╕Хр╕▓р╕гр╣Мр╕Ч Command Prompt р╣Бр╕ер╕░р╕гр╕▒р╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣Мр╕Щр╕╡р╣Йр╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З
    pause
    exit /b 1
)

for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
echo тЬЕ р╕Юр╕Ъ Python %PYTHON_VERSION%

:: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ pip
pip --version >nul 2>&1
if %errorlevel% neq 0 (
    echo тЭМ р╣Др╕бр╣Ир╕Юр╕Ъ pip! р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З pip
    echo    python -m ensurepip --default-pip
    pause
    exit /b 1
)

echo тЬЕ р╕Юр╕Ъ pip
echo.

:: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Git (р╕Цр╣Йр╕▓р╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ)
git --version >nul 2>&1
if %errorlevel% == 0 (
    echo тЬЕ р╕Юр╕Ъ Git
) else (
    echo тЪая╕П  р╣Др╕бр╣Ир╕Юр╕Ъ Git (р╕Ир╕░р╕Вр╣Йр╕▓р╕б git operations)
)

echo.
echo ЁЯУБ р╕Бр╕│р╕ер╕▒р╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М...
if not exist "data" mkdir data
if not exist "model" mkdir model
if not exist "config" mkdir config
if not exist ".streamlit" mkdir .streamlit
echo тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в

echo.
echo ЁЯРН р╕Бр╕│р╕ер╕▒р╕Зр╕кр╕гр╣Йр╕▓р╕З Virtual Environment...
if exist "venv" (
    echo тЪая╕П  р╕Юр╕Ъ venv р╣Ар╕Бр╣Ир╕▓ р╕Бр╕│р╕ер╕▒р╕Зр╕ер╕Ър╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕лр╕бр╣И...
    rmdir /s /q venv
)

python -m venv venv
if %errorlevel% neq 0 (
    echo тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕З virtual environment р╣Др╕Фр╣Й
    pause
    exit /b 1
)
echo тЬЕ р╕кр╕гр╣Йр╕▓р╕З Virtual Environment р╕кр╕│р╣Ар╕гр╣Зр╕И

echo.
echo ЁЯФМ р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ Virtual Environment...
call venv\Scripts\activate.bat
if %errorlevel% neq 0 (
    echo тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ virtual environment р╣Др╕Фр╣Й
    pause
    exit /b 1
)
echo тЬЕ р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ Virtual Environment р╕кр╕│р╣Ар╕гр╣Зр╕И

echo.
echo ЁЯУж р╕Бр╕│р╕ер╕▒р╕Зр╕нр╕▒р╕Ыр╣Ар╕Бр╕гр╕Ф pip...
python -m pip install --upgrade pip
if %errorlevel% neq 0 (
    echo тЪая╕П  р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╕▒р╕Ыр╣Ар╕Бр╕гр╕Ф pip р╣Др╕Фр╣Й р╣Бр╕Хр╣Ир╕Ир╕░р╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Хр╣Ир╕н
)

echo.
echo ЁЯУЪ р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Python packages...
echo    (р╕Бр╕гр╕░р╕Ър╕зр╕Щр╕Бр╕▓р╕гр╕Щр╕╡р╣Йр╕нр╕▓р╕Ир╣Гр╕Кр╣Йр╣Ар╕зр╕ер╕▓ 5-10 р╕Щр╕▓р╕Чр╕╡)
echo.

:: р╕нр╕▒р╕Ыр╣Ар╕Бр╕гр╕Ф pip р╣Бр╕ер╕░ setuptools р╕Бр╣Ир╕нр╕Щ
echo ЁЯФз р╕Бр╕│р╕ер╕▒р╕Зр╕нр╕▒р╕Ыр╣Ар╕Бр╕гр╕Ф pip р╣Бр╕ер╕░ setuptools...
python -m pip install --upgrade pip setuptools wheel
if %errorlevel% neq 0 (
    echo тЪая╕П  р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╕▒р╕Ыр╣Ар╕Бр╕гр╕Ф pip р╣Др╕Фр╣Й р╣Бр╕Хр╣Ир╕Ир╕░р╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Хр╣Ир╕н
)

:: р╕ер╕нр╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕Ър╕Ър╣Ар╕Хр╣Зр╕бр╕Бр╣Ир╕нр╕Щ
echo ЁЯЪА р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З packages р╣Бр╕Ър╕Ър╣Ар╕Хр╣Зр╕б...
pip install -r requirements.txt --timeout=300
if %errorlevel% neq 0 (
    echo тЪая╕П  р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Бр╕Ър╕Ър╣Ар╕Хр╣Зр╕бр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з р╕Бр╕│р╕ер╕▒р╕Зр╕ер╕нр╕Зр╣Бр╕Ър╕Ъ minimal...
    echo.
    
    :: р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З essential packages р╕Чр╕╡р╕ер╕░р╕Хр╕▒р╕з
    echo ЁЯУж р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З packages р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ...
    pip install "streamlit>=1.25.0,<2.0.0"
    pip install "pandas>=1.5.0,<2.0.0"  
    pip install "numpy>=1.21.0,<1.25.0"
    pip install "requests>=2.28.0"
    
    :: р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З optional packages
    echo ЁЯФз р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З packages р╣Ар╕кр╕гр╕┤р╕б...
    pip install fuzzywuzzy python-levenshtein python-dotenv tqdm plotly matplotlib openpyxl 2>nul
    
    :: р╕ер╕нр╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З AI packages
    echo ЁЯдЦ р╕ер╕нр╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З AI packages...
    pip install scikit-learn 2>nul
    pip install sentence-transformers 2>nul
    
    :: р╕ер╕нр╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З PyTorch CPU
    echo ЁЯФе р╕ер╕нр╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З PyTorch...
    pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu 2>nul
    if %errorlevel% neq 0 (
        echo тЪая╕П  р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З PyTorch р╣Др╕Фр╣Й - р╕Ир╕░р╣Гр╕Кр╣Йр╣Вр╕лр╕бр╕Фр╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щ
    )
)

if %errorlevel% neq 0 (
    echo тЭМ р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з! р╕Бр╕│р╕ер╕▒р╕Зр╕ер╕нр╕Зр╕зр╕┤р╕Шр╕╡р╕нр╕╖р╣Ир╕Щ...
    echo ЁЯФД р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕Ир╕▓р╕Б requirements.txt...
    pip install -r requirements.txt
    if %errorlevel% neq 0 (
        echo тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З packages р╣Др╕Фр╣Й
        echo.
        echo ЁЯЫая╕П  р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓:
        echo    1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕нр╕┤р╕Щр╣Ар╕Чр╕нр╕гр╣Мр╣Ар╕Щр╣Зр╕Х
        echo    2. р╕ер╕нр╕Зр╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╕Фр╣Йр╕зр╕вр╕Хр╕Щр╣Ар╕нр╕З: pip install -r requirements.txt
        echo    3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Python version (р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╣Зр╕Щ 3.8+)
        pause
        exit /b 1
    )
)

echo тЬЕ р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Python packages р╕кр╕│р╣Ар╕гр╣Зр╕И!

echo.
echo ЁЯЧГя╕П  р╕Бр╕│р╕ер╕▒р╕Зр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Др╕Яр╕ер╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕е...
if not exist "thai_food_processed_cleaned.csv" (
    if exist "thai_food_processed.csv" (
        echo тЪая╕П  р╕Юр╕Ър╣Др╕Яр╕ер╣М thai_food_processed.csv р╕Бр╕│р╕ер╕▒р╕Зр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Гр╕лр╕бр╣И...
        python preprocess.py --input thai_food_processed.csv --output thai_food_processed_cleaned.csv --enhanced
    ) else (
        echo тЪая╕П  р╣Др╕бр╣Ир╕Юр╕Ър╣Др╕Яр╕ер╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕ер╕▒р╕Б р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Др╕Яр╕ер╣М thai_food_processed.csv
        echo    р╕лр╕гр╕╖р╕н thai_food_processed_cleaned.csv р╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣Мр╕лр╕ер╕▒р╕Б
    )
) else (
    echo тЬЕ р╕Юр╕Ър╣Др╕Яр╕ер╣Мр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕ер╕▒р╕Б
)

echo.
echo ЁЯФз р╕Бр╕│р╕ер╕▒р╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓...
if not exist ".streamlit\secrets.toml" (
    echo # USDA API Configuration > .streamlit\secrets.toml
    echo USDA_API_KEY = "DEMO_KEY" >> .streamlit\secrets.toml
    echo # Get your free API key from: https://fdc.nal.usda.gov/api-key-signup.html >> .streamlit\secrets.toml
    echo.>> .streamlit\secrets.toml
    echo # Application Settings >> .streamlit\secrets.toml
    echo [app_settings] >> .streamlit\secrets.toml
    echo max_search_results = 10 >> .streamlit\secrets.toml
    echo enable_fuzzy_search = true >> .streamlit\secrets.toml
    echo.
    echo тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М .streamlit\secrets.toml
    echo ЁЯУЭ р╕Бр╕гр╕╕р╕Ур╕▓р╣Бр╕Бр╣Йр╣Др╕В USDA_API_KEY р╣Гр╕Щр╣Др╕Яр╕ер╣М .streamlit\secrets.toml
)

echo.
echo ЁЯЪА р╕Бр╕│р╕ер╕▒р╕Зр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З...
python -c "import streamlit, pandas, sentence_transformers; print('тЬЕ All dependencies OK')" 2>nul
if %errorlevel% == 0 (
    echo тЬЕ р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕кр╕│р╣Ар╕гр╣Зр╕И!
) else (
    echo тЪая╕П  р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕ер╣Йр╕бр╣Ар╕лр╕ер╕з р╣Бр╕Хр╣Ир╕нр╕▓р╕Ир╕вр╕▒р╕Зр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Др╕Фр╣Й
)

echo.
echo ЁЯУ▒ р╕Бр╕│р╕ер╕▒р╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М shortcuts...
echo @echo off > run_app.bat
echo call venv\Scripts\activate.bat >> run_app.bat
echo streamlit run app.py >> run_app.bat
echo pause >> run_app.bat

echo @echo off > fetch_usda_data.bat
echo call venv\Scripts\activate.bat >> fetch_usda_data.bat
echo python usda_nutrition_fetcher.py --recipes thai_food_processed_cleaned.csv --output usda_nutrition_latest.csv >> fetch_usda_data.bat
echo pause >> fetch_usda_data.bat

echo тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣М shortcuts

echo.
echo ================================================================
echo ЁЯОЙ р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ!
echo ================================================================
echo.
echo ЁЯУЛ р╕кр╕гр╕╕р╕Ыр╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З:
echo    тЬЕ Virtual Environment: venv\
echo    тЬЕ Python Packages: р╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ
echo    тЬЕ р╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓: .streamlit\secrets.toml
echo    тЬЕ Shortcuts: run_app.bat, fetch_usda_data.bat
echo.
echo ЁЯЪА р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕гр╕▒р╕Щр╣Бр╕нр╕Ыр╕Юр╕ер╕┤р╣Ар╕Др╕Кр╕▒р╕Щ:
echo    1. р╕Фр╕▒р╕Ър╣Ар╕Ър╕┤р╕ер╕Др╕ер╕┤р╕Б run_app.bat
echo    2. р╕лр╕гр╕╖р╕нр╕гр╕▒р╕Щр╣Гр╕Щр╕Др╕нр╕бр╕бр╕▓р╕Щр╕Фр╣Мр╣Др╕ер╕Щр╣М:
echo       - call venv\Scripts\activate.bat
echo       - streamlit run app.py
echo.
echo ЁЯМР р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╕гр╕▒р╕Щр╣Бр╕ер╣Йр╕з р╣Ар╕Ыр╕┤р╕Фр╣Ар╕зр╣Зр╕Ър╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╣Др╕Ыр╕Чр╕╡р╣И:
echo    http://localhost:8501
echo.
echo ЁЯУЪ р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Цр╕▒р╕Фр╣Др╕Ы:
echo    1. р╣Бр╕Бр╣Йр╣Др╕В USDA_API_KEY р╣Гр╕Щр╣Др╕Яр╕ер╣М .streamlit\secrets.toml
echo    2. р╕Фр╕▓р╕зр╕Щр╣Мр╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕лр╕бр╣Ир╕Фр╣Йр╕зр╕в fetch_usda_data.bat
echo    3. р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Бр╕нр╕Ыр╕Юр╕ер╕┤р╣Ар╕Др╕Кр╕▒р╕Щ
echo.
echo ЁЯЖШ р╕лр╕▓р╕Бр╕Юр╕Ър╕Ыр╕▒р╕Нр╕лр╕▓:
echo    - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ README.md р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Др╕╣р╣Ир╕бр╕╖р╕нр╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓
echo    - р╕лр╕гр╕╖р╕нр╣Ар╕Ыр╕┤р╕Ф Issue р╣Гр╕Щ GitHub
echo.
echo р╕Бр╕Ф Enter р╣Ар╕Юр╕╖р╣Ир╕нр╕Ыр╕┤р╕Фр╕лр╕Щр╣Йр╕▓р╕Хр╣Ир╕▓р╕Зр╕Щр╕╡р╣Й...
pause >nul
